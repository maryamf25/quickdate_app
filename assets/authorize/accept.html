<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Authorize.Net Accept.js Tokenization</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .field { margin-bottom: 10px; }
    label { display:block; font-weight:600; margin-bottom:4px }
    input { width:100%; padding:8px; box-sizing:border-box }
    button { padding:10px 16px; font-size:16px }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h3>Enter Card Details</h3>
  <div id="error" class="error"></div>
  <div class="field"><label>Card Number</label><input id="cardNumber" placeholder="4111 1111 1111 1111"></div>
  <div class="field"><label>Expiry Month (MM)</label><input id="expMonth" placeholder="01"></div>
  <div class="field"><label>Expiry Year (YYYY)</label><input id="expYear" placeholder="2026"></div>
  <div class="field"><label>CVV</label><input id="cvv" placeholder="123"></div>
  <div class="field"><label>Name on Card</label><input id="cardName" placeholder="John Doe"></div>
  <div style="text-align:right"><button id="tokenize">Tokenize & Pay</button></div>

  <script>
    // Will be populated by Flutter via setConfig
    window.AUTHORIZE_CONFIG = null;

    function setConfig(cfg) {
      try {
        window.AUTHORIZE_CONFIG = cfg;
        // inject Accept.js depending on mode
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = (cfg.mode === 'SANDBOX') ? 'https://jstest.authorize.net/v3/Accept.js' : 'https://js.authorize.net/v3/Accept.js';
        document.head.appendChild(script);
        // show ready message to Flutter
        if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'ready'}));
      } catch (e) {
        if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'error', message: e.message}));
      }
    }

    function displayError(msg){
      document.getElementById('error').innerText = msg;
    }

    function tokenize() {
      if (!window.AUTHORIZE_CONFIG) { displayError('Configuration not set'); return; }
      var cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g,'');
      var expMonth = document.getElementById('expMonth').value.padStart(2,'0');
      var expYear = document.getElementById('expYear').value;
      if (expYear.length === 2) expYear = '20' + expYear;
      var cvv = document.getElementById('cvv').value;

      if (!cardNumber || !expMonth || !expYear || !cvv) { displayError('Please fill all card fields'); return; }

      var authData = {
        clientKey: window.AUTHORIZE_CONFIG.clientKey,
        apiLoginID: window.AUTHORIZE_CONFIG.apiLoginId
      };

      var cardData = {
        cardNumber: cardNumber,
        month: expMonth,
        year: expYear,
        cardCode: cvv
      };

      var secureData = { authData: authData, cardData: cardData };

      try {
        Accept.dispatchData(secureData, function(response){
          if (!response) {
            if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'error', message:'no_response_from_accept'}));
            return;
          }
          if (response.messages && response.messages.resultCode === "Error") {
            var msg = (response.messages && response.messages.message && response.messages.message[0] && response.messages.message[0].text) ? response.messages.message[0].text : 'Tokenization error';
            if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'error', message:msg}));
            return;
          }
          if (response.opaqueData && response.opaqueData.dataDescriptor && response.opaqueData.dataValue) {
            if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'ok', dataDescriptor: response.opaqueData.dataDescriptor, dataValue: response.opaqueData.dataValue}));
            return;
          }
          // fallback error
          if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'error', message:'unknown_tokenization_result'}));
        });
      } catch (ex) {
        if (window.Flutter) window.Flutter.postMessage(JSON.stringify({status:'error', message:ex.message}));
      }
    }

    document.getElementById('tokenize').addEventListener('click', tokenize);
  </script>
</body>
</html>

